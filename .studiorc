#!/bin/bash
#

hab pkg install chef/studio-common >/dev/null
source "$(hab pkg path chef/studio-common)/bin/studio-common"

# This removes the visual mode when select text with the mouse in vim.
echo "set mouse-=a" >> ~/.vimrc

install_if_missing core/curl curl

export SERVICE_NAME="distributed_inspec_notifier"
export PORT=8080

function start() {
  build

  create_config

  hab svc load $HAB_ORIGIN/$SERVICE_NAME
}

function rebuild() {
  build
  hab svc unload $HAB_ORIGIN/$SERVICE_NAME
  sleep 3
  hab svc load $HAB_ORIGIN/$SERVICE_NAME
}

function send_report() {
  install_if_missing core/curl curl
  install_if_missing core/jq-static jq

  local examples_json_path=$1
  local endpoint="http://localhost:$PORT/data-collector/v0/"
  local uuid=$(uuidgen)
  local entity_uuid=$(uuidgen)
  local date=$(date --rfc-3339=seconds | sed 's/ /T/' | sed 's/\+.*/Z/')

  tmp_report_json="$(jq --arg date "$date" --arg id "$uuid" --arg nodeid "$entity_uuid" '.report_uuid = $id | .node_uuid = $nodeid | .end_time = $date' <$examples_json_path)"

  echo "$tmp_report_json" | curl --data "@-" $endpoint
}

function send_success_example() {

  send_report "/src/examples/compliance-success-tiny-report.json"
}

function send_failure_example() {

  send_report "/src/examples/compliance-failure-big-report.json"
}

document "rbuild" <<DOC
  Builds and reloads the binary from the '/src/target/debug' directory.

  This is faster than the "rebuild" command, but does not update any habitat changes
DOC
function rbuild() {
  hab svc unload $HAB_ORIGIN/$SERVICE_NAME
  sleep 1

  hab pkg install -b core/rust
  hab pkg install -b core/gcc
  hab pkg install -b core/gcc-libs/9.1.0/20200305225533
  hab pkg install -b core/glibc
  hab pkg install -b core/pkg-config
  hab pkg install -b core/make

  LD_LIBRARY_PATH="$(hab pkg path core/gcc-libs)/lib/" cargo build

  cp /src/target/debug/$SERVICE_NAME $(hab pkg path $HAB_ORIGIN/$SERVICE_NAME)/bin/

  hab svc load $HAB_ORIGIN/$SERVICE_NAME
}

document "kill_running_service" <<DOC
  This kills the running service. Where hab sup should restart. 
DOC
function kill_running_service() {
  install_if_missing core/busybox-static pgrep >/dev/null
  SERVICE_PID=$(pgrep $SERVICE_NAME)
  if [[ -n ${SERVICE_PID} ]]; then
    kill $SERVICE_PID
  fi
}

function create_config() {
  mkdir -p /hab/user/distributed_inspec_notifier/config/
  printf "[service]\n host = \"localhost\"\n port = \"$PORT\"\n\n" > /hab/user/distributed_inspec_notifier/config/user.toml
  printf "[webhook]\n url = \"http://requestbin.sjcmmsn.com/1nypmdf1\"\n" >> /hab/user/distributed_inspec_notifier/config/user.toml
}

function status() {
  hab sup status;
}

# Saves the in memory bash history to a file
function save_history() {
  history -a /src/.bash_history
}

# if .studiorc is being sourced from an already running studio, don't reset bash
# history -- this is achieved by saving the current history before it is re-read
save_history

# Load the bash history from a file
history -r /src/.bash_history

function cleanup() {
    save_history
}

# When exiting the studio save the bash history to a file
trap cleanup EXIT
